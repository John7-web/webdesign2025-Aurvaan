<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>3D Horse Racing Game</title>
<style>
    body { margin: 0; overflow: hidden; background: #87ceeb; }
    #hud {
        position: absolute; top: 20px; left: 20px; 
        font-size: 24px; font-family: sans-serif; color: white;
        text-shadow: 2px 2px 4px #000;
    }
    #countdown {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 100px;
        color: white;
        font-family: sans-serif;
        text-shadow: 4px 4px 10px black;
        display: none;
    }
</style>
</head>
<body>

<div id="hud">Speed: 0</div>
<div id="countdown">3</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

<script>
/* ---------------------------------------------------
   SETUP
--------------------------------------------------- */
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 5000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

/* ---------------------------------------------------
   LIGHTING
--------------------------------------------------- */
scene.add(new THREE.AmbientLight(0xffffff, 0.6));
const sun = new THREE.DirectionalLight(0xffffff, 1);
sun.position.set(50, 100, 50);
scene.add(sun);

/* ---------------------------------------------------
   TRACK
--------------------------------------------------- */
const track = new THREE.Mesh(
    new THREE.PlaneGeometry(2000, 50),
    new THREE.MeshLambertMaterial({ color: 0x228B22 })
);
track.rotation.x = -Math.PI / 2;
scene.add(track);

/* ---------------------------------------------------
   HORSE MODEL
--------------------------------------------------- */
function createHorse(color) {
    const mat = new THREE.MeshLambertMaterial({ color });

    // Body
    const body = new THREE.Mesh(new THREE.BoxGeometry(5, 2, 2), mat);

    // Head
    const head = new THREE.Mesh(new THREE.BoxGeometry(1.4, 1.2, 1.2), mat);
    head.position.set(3, 0.5, 0);
    body.add(head);

    // Legs
    const legGeo = new THREE.BoxGeometry(0.6, 1.6, 0.6);

    const legFL = new THREE.Mesh(legGeo, mat);
    const legFR = new THREE.Mesh(legGeo, mat);
    const legBL = new THREE.Mesh(legGeo, mat);
    const legBR = new THREE.Mesh(legGeo, mat);

    legFL.position.set(1.5, -1.8, 0.9);
    legFR.position.set(1.5, -1.8, -0.9);
    legBL.position.set(-1.5, -1.8, 0.9);
    legBR.position.set(-1.5, -1.8, -0.9);

    body.add(legFL, legFR, legBL, legBR);

    // Store legs for galloping animation
    body.legs = { legFL, legFR, legBL, legBR };

    return body;
}

/* ---------------------------------------------------
   PLAYER + AI HORSES
--------------------------------------------------- */
const player = createHorse(0xffcc55);
player.position.set(-900, 1, 0);
scene.add(player);

const aiHorses = [];
for (let i = 0; i < 3; i++) {
    let ai = createHorse(0x5555ff + i * 5000);
    ai.position.set(-900, 1, (i - 1) * 6);
    aiHorses.push({
        mesh: ai,
        speed: 14 + Math.random() * 4
    });
    scene.add(ai);
}

/* ---------------------------------------------------
   INPUT
--------------------------------------------------- */
let keys = {};
document.addEventListener("keydown", e => (keys[e.key] = true));
document.addEventListener("keyup", e => (keys[e.key] = false));

/* Movement values */
let speed = 0;
let maxSpeed = 22;

/* ---------------------------------------------------
   GALLOPING ANIMATION
--------------------------------------------------- */
let gallopTime = 0;

function gallopAnimation(horse, animSpeed) {
    gallopTime += animSpeed * 0.3;

    const swing = Math.sin(gallopTime) * 0.8;
    const swingOpp = Math.sin(gallopTime + Math.PI) * 0.8;

    horse.legs.legFL.rotation.x = swing;
    horse.legs.legBR.rotation.x = swing;
    horse.legs.legFR.rotation.x = swingOpp;
    horse.legs.legBL.rotation.x = swingOpp;
}

/* ---------------------------------------------------
   COUNTDOWN
--------------------------------------------------- */
let raceStarted = false;

function startCountdown() {
    const cd = document.getElementById("countdown");
    cd.style.display = "block";
    let count = 3;

    cd.innerText = count;

    const timer = setInterval(() => {
        count--;

        if (count === 0) cd.innerText = "GO!";
        else if (count < 0) {
            cd.style.display = "none";
            raceStarted = true;
            clearInterval(timer);
        } else cd.innerText = count;
    }, 1000);
}
startCountdown();

/* ---------------------------------------------------
   FIXED CAMERA
--------------------------------------------------- */
const desiredOffset = new THREE.Vector3(0, 8, 18);
const lookOffset = new THREE.Vector3(0, 3, 0);

function updateCamera() {
    const rotOffset = desiredOffset.clone().applyAxisAngle(
        new THREE.Vector3(0, 1, 0),
        player.rotation.y
    );

    const targetPos = player.position.clone().add(rotOffset);
    camera.position.lerp(targetPos, 0.08);

    const lookAt = player.position.clone().add(lookOffset);
    camera.lookAt(lookAt);
}

/* ---------------------------------------------------
   MAIN LOOP
--------------------------------------------------- */
const fwd = new THREE.Vector3();
const finishX = 900;

function animate() {
    requestAnimationFrame(animate);

    if (raceStarted) {
        // Acceleration
        if (keys["w"]) speed = Math.min(speed + 0.4, maxSpeed);
        else speed = Math.max(speed - 0.3, 0);

        // Turning
        if (keys["a"]) player.rotation.y += 0.04;
        if (keys["d"]) player.rotation.y -= 0.04;

        // Fixed forward movement
        player.getWorldDirection(fwd);
        fwd.y = 0;
        fwd.normalize();
        player.position.addScaledVector(fwd, speed * 0.3);

        // Speed HUD
        document.getElementById("hud").textContent = "Speed: " + Math.floor(speed);

        // Galloping
        gallopAnimation(player, speed / maxSpeed);

        // AI horses
        aiHorses.forEach(ai => {
            ai.mesh.position.x += ai.speed * 0.3;
            gallopAnimation(ai.mesh, ai.speed / 22);
        });
    }

    updateCamera();

    // Finish line
    if (raceStarted && player.position.x >= finishX) {
        alert("ðŸ† YOU WIN!");
        raceStarted = false;
    }

    aiHorses.forEach(ai => {
        if (raceStarted && ai.mesh.position.x >= finishX) {
            alert("â— AI Horse Wins!");
            raceStarted = false;
        }
    });

    renderer.render(scene, camera);
}

animate();

/* ---------------------------------------------------
   RESIZE HANDLER
--------------------------------------------------- */
window.addEventListener("resize", () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>
