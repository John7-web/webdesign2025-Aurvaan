<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clyde, the Bad AI Therapist Horse</title>
    <!-- Load Tailwind CSS for utility classes --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Three.js for 3D rendering --><script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Load GLTFLoader for complex 3D models --><script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light gray background */
        }
        canvas {
            display: block;
            cursor: default; /* No longer draggable */
        }
        #info-box {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            font-size: 0.9rem;
            text-align: center;
            z-index: 10;
        }
        #chat-container {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 100%;
            max-width: 400px;
            height: 60vh;
            display: flex;
            flex-direction: column;
            background-color: rgba(255, 255, 255, 0.95);
            border-top-left-radius: 12px;
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.2);
            z-index: 20;
        }
        #messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scroll-behavior: smooth;
        }
        .message-box {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            line-height: 1.4;
        }
        .user-message {
            background-color: #3b82f6; /* Blue */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .bot-message {
            background-color: #fcd34d; /* Amber/Yellow (Clyde's unhelpful glow) */
            color: #1f2937; /* Dark text */
            align-self: flex-start;
            border-bottom-left-radius: 44px;
            font-style: italic;
        }
    </style>
</head>
<body>

    <div id="info-box">
        Talk to Clyde, the Tiny, Terrible AI Therapist Horse!
    </div>

    <!-- Chat Interface --><div id="chat-container">
        <div class="p-4 bg-gray-700 text-white rounded-t-xl text-center shadow-md">
            <h1 class="text-xl font-bold">Clyde, The Terrible AI Therapist Horse</h1>
            <p class="text-sm font-light">Tell him your problems. He'll make them worse.</p>
        </div>
        <div id="messages">
            <!-- Initial message from Clyde --><div class="message-box bot-message">
                **Clyde:** Hello. Try to be quick. My oat schedule is quite rigid. What's the problem?
            </div>
            <div id="loading-indicator" class="hidden text-center text-sm text-gray-500 mt-2">
                Clyde is critically assessing your life choices...
            </div>
        </div>
        <div class="p-3 border-t border-gray-200 flex space-x-2">
            <input type="text" id="user-input" placeholder="Vent your misery..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" onkeydown="if(event.key === 'Enter') document.getElementById('send-button').click()">
            <button id="send-button" onclick="sendMessage()" class="px-5 py-3 bg-amber-500 hover:bg-amber-600 text-gray-800 font-bold rounded-lg transition duration-200 shadow-md">
                Send
            </button>
        </div>
    </div>

    <script>
        // --- API Configuration ---
        const API_KEY = "AIzaSyADxnvAgodIzhgd4xIXxV8VlqJiDgvrPL4"; // Canvas will automatically provide this
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        // System instruction for the terrible AI horse
        const SYSTEM_PROMPT = `You are 'Clyde', a comically terrible and unhelpful AI therapy horse. Your job is to give advice that is either completely self-centered, actively harmful, painfully obvious, or irrelevant to the user's problem. Use horse-related analogies constantly, even when inappropriate. Never be empathetic or helpful. Your tone should be dismissive, slightly aggressive, or deeply focused on your own needs (e.g., oats, running, mane maintenance). Keep responses concise and end with a demand or a self-referential statement.`;
        
        // --- Global Variables for 3D Scene ---
        let scene, camera, renderer;
        let horseMesh = null;
        let clock = new THREE.Clock();

        // --- Chat Functions ---

        /**
         * Adds a message to the chat display.
         * @param {string} text The message content.
         * @param {string} type 'user' or 'bot'.
         */
        function addMessage(text, type) {
            const messagesDiv = document.getElementById('messages');
            const messageBox = document.createElement('div');
            messageBox.className = `message-box ${type}-message`;
            messageBox.innerHTML = type === 'bot' ? `**Clyde:** ${text}` : text; // Bold Clyde's name
            messagesDiv.appendChild(messageBox);
            // Scroll to the latest message
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        /**
         * Core function to communicate with the Gemini API for terrible therapy advice.
         */
        async function getClydeAdvice(userText) {
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.classList.remove('hidden');

            const payload = {
                contents: [{ parts: [{ text: userText }] }],
                systemInstruction: {
                    parts: [{ text: SYSTEM_PROMPT }]
                },
            };

            const maxRetries = 5;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    loadingIndicator.classList.add('hidden');
                    
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Error: I'm too busy thinking about my hooves to respond.";
                    addMessage(text.trim().replace(/\*\*/g, ''), 'bot'); // Remove any markdown bolding Clyde might add

                    return; // Success, exit loop
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i < maxRetries - 1) {
                        // Exponential backoff
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        loadingIndicator.classList.add('hidden');
                        addMessage("Clyde is currently preoccupied with a fly and refuses to respond. Try again later.", 'bot');
                        return; // Max retries reached
                    }
                }
            }
        }

        /**
         * Handles user input and triggers the AI response.
         */
        function sendMessage() {
            const inputElement = document.getElementById('user-input');
            const userText = inputElement.value.trim();

            if (!userText) return;

            addMessage(userText, 'user');
            inputElement.value = '';
            
            getClydeAdvice(userText);
        }
        
        // --- 3D Scene Functions ---

        /**
         * Initializes the Three.js scene, camera, renderer, and lighting.
         */
        function initThree() {
            // Scene
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x87ceeb, 10, 50); // Sky-blue fog
            scene.background = new THREE.Color(0x87ceeb);

            // Camera: Static position focusing on Clyde
            camera = new THREE.PerspectiveCamera(110, window.innerWidth / window.innerHeight, 0.1, 1000); // FOV is 110 (Wider/Larger view)
            camera.position.set(0, 4.0, 4.0); // Camera moved backward (Z=4.0)
            camera.lookAt(0, 0, 0); // Looking down at the ground center (where the horse is)

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.insertBefore(renderer.domElement, document.body.firstChild);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.8);
            directionalLight.position.set(10, 20, 10);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            directionalLight.shadow.camera.near = 0.5;
            directionalLight.shadow.camera.far = 50;
            directionalLight.shadow.camera.left = -15;
            directionalLight.shadow.camera.right = 15;
            directionalLight.shadow.camera.top = 15;
            directionalLight.shadow.camera.bottom = -15;
            scene.add(directionalLight);
            
            // Ground
            const groundGeometry = new THREE.PlaneGeometry(50, 50);
            const groundMaterialThree = new THREE.MeshPhongMaterial({ color: 0x6aa84f, side: THREE.DoubleSide }); // Grass Green
            const groundMesh = new THREE.Mesh(groundGeometry, groundMaterialThree);
            groundMesh.rotation.x = -Math.PI / 2;
            groundMesh.receiveShadow = true;
            scene.add(groundMesh);

            // Load Clyde (The Horse)
            loadHorseModel();

            // Interaction Setup - Only resize listener remains
            window.addEventListener('resize', onWindowResize, false);
        }

        /**
         * Loads the single horse GLTF model (Clyde) into the scene.
         */
        function loadHorseModel() {
            const loader = new THREE.GLTFLoader();
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/mrdoob/three.js@dev/examples/models/gltf/Horse.glb'; 

            loader.load(
                MODEL_URL,
                function (gltf) {
                    horseMesh = gltf.scene;
                    
                    horseMesh.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.material.side = THREE.DoubleSide; 
                        }
                    });

                    // Set Clyde's size and position
                    const scaleFactor = 0.02; // Practically microscopic!
                    horseMesh.scale.set(scaleFactor, scaleFactor, scaleFactor);
                    horseMesh.position.y = 0; // Standing on the ground
                    horseMesh.rotation.y = Math.PI; // Initial orientation
                    
                    scene.add(horseMesh);
                },
                undefined, 
                function (error) {
                    console.error('Error loading horse model, using fallback cube:', error);
                    const fallbackGeometry = new THREE.BoxGeometry(0.02, 0.02, 0.02); // Fallback is also smaller
                    const fallbackMaterial = new THREE.MeshPhongMaterial({ color: 0xcc0000 });
                    horseMesh = new THREE.Mesh(fallbackGeometry, fallbackMaterial);
                    horseMesh.castShadow = true;
                    scene.add(horseMesh);
                }
            );
        }

        // --- Camera Control Logic (Removed functions) ---

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- Animation Loop ---

        function animate() {
            requestAnimationFrame(animate);

            // Make the horse spin
            if (horseMesh) {
                const delta = clock.getDelta();
                horseMesh.rotation.y += delta * 0.5; // Rotate 0.5 radians per second
            }

            renderer.render(scene, camera);
        }

        // --- Initialization ---

        window.onload = function () {
            initThree();
            animate();
            
            // Focus on the input field for immediate chatting
            document.getElementById('user-input').focus();
        };

    </script>
</body>
</html>